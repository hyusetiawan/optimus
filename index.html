<html>
<head>
    <meta name="slug" content="optimus" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/codemirror.min.css" rel="stylesheet" type='text/css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/codemirror.min.css" rel="stylesheet" type='text/css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/theme/monokai.min.css" rel="stylesheet" type='text/css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/3.3.0/css/tooltipster.min.css" rel="stylesheet" type='text/css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/3.3.0/css/themes/tooltipster-light.min.css" rel="stylesheet" type='text/css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-tagsinput/1.3.6/jquery.tagsinput.min.css" type="text/css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="main.css">
    <title>OPTIMUS</title>
</head>

<body>
    <!-- taken from: http://codepen.io/philhoyt/pen/ujHzd-->
    <nav class="page-level primary_nav_wrap">
        <ul>
            <li class="logo"><a href="#/">OPTIMUS</a></li>
            <li><a href="#">Mode</a>
                <ul>
                    <li><a href="#/edit">Edit</a></li>
                    <li><a href="#/ready">Ready</a></li>
                </ul>
            </li>
            <li><a href="#/about">About</a></li>
            <li><a href="#/help">Help</a></li>
        </ul>
    </nav>
    <div class="cleared"></div>
    <hr />
    <div class="views welcome">Welcome</div>
    <div class="views ready">
        <form class="upload-file">
            <div class="menu">
                <input class="clear-files" type="button" value="CLEAR FILES" />
                <input class="process-all" type="button" value="PROCESS ALL" />
            </div>
            <table id="file-list" border="0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Size</th>
                        <th>Process</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <input id="file-input" type="file" />
            <label id="file-info"  for="file-input">Click to Upload Files or Drag and Drop Files</label>
        </form>

        <div id="welcome-message"></div>

    </div>
    <div class="views edit">
        <nav class="sub-level primary_nav_wrap">
            <ul >
                <li><a href="#/edit/transformer">Transformer</a></li>
                <li><a href="#/edit/output">Output</a></li>
                <li><a href="#/edit/extras">Extras</a></li>
            </ul>
            <form class="dev-form">
                <input title="saves the app <br />hotkey: <hotkey>" class="save-button" type="button" value="SAVE" />
                <input title="runs the app against the selected file to the dropdown <br />hotkey: <hotkey>" class="run-button" type="button" value="RUN">
                <select title="Drop some files in Mode > Ready, they will be available here to test your transformation logic against for debugging purposes" id="dev-file-list"><option> - </option></select>
            </form>
        </nav>

        <div class="cleared"></div>
        <br />
        <div class="subviews extras">
            <textarea id="welcome-message-input" placeholder="write a welcome message that will be shown at Mode > Ready for people who will use the transformer, clearly explaining what your transformer does will go a long way. Supports Markdown."></textarea>
        </div>
        <div class="subviews transformer">
            <div class="padded">
                <div class="auto-parse">
                    <b>Auto Parse:</b>
                    <select id="auto" title="A convenience method before calling transformer to automatically parses the content of the  file <br />
                                            and pass it to transformer() as $data parameter so you can focus on transforming the data not parsing<br />
                                             AUTO: detects csv/json">
                        <option> - </option>
                        <option value="auto">AUTO</option>
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="readAsText">AsText</option>
                        <option value="readAsDataURL">AsDataURL</option>
                        <option value="readAsBinaryString">asBinaryString</option>
                        <option value="readAsArrayBuffer">asArrayBuffer</option>
                    </select>
                </div>

                <label class="editor-theme" title="change the editor's theme">
                    Editor's Theme
                    <select id="theme"></select> <br />
                </label>
            </div>

            <textarea id="transformer">function transformer(file, send, $data){
  /**
    @file   the uploaded file (a File instance)
    @send   function to send the result: send(result) to send the whole processed data, send(item, index, total) to indicate progress
            Use send with the counter, if the file is a large array, this will also activate progress indicator and is zero-based index
            If the file is small (under 100mb), you can send the whole processed data safely.
    @$data  parsed data, null if you didn't choose the auto parse (see above)
  */

  var scripts = [
    'https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js'
  ]
  importScripts.apply(null, scripts) // if you would like to use other libraries
  var total = $data.length
  for (var i = 0; i < total; i++){
    //do some transformation
    send($data[i], i, total)
  }

  return $data // return the result
}</textarea>
        </div>
        <div class="subviews output">
            <form class="padded">
                <table>
                    <tr>
                        <td class="input-label">Content Type</td>
                        <td>
                            <select id="content-type" name="content-type">
                                <option value="original">ORIGINAL</option>
                                <option value="json">JSON</option>
                                <option value="csv">CSV</option>
                                <option value="txt">TXT</option>
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <td class="input-label">Filename Pattern</td>
                        <td style="">
                            <input id="filename-pattern" type="text" name="tags" placeholder="" class="tags-input" value="$original"/>
                            <input id="select-tag" type="text" name="tags" placeholder="Tags" class="tags-input"
                                   value="$timestamp, $original, $counter, $uuid" />
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>

    <div class="views about padded">
        <h3 class="title">About</h3>
        <p>
            OPTIMUS is an open source transformation tool using <a href="https://unopi.co">unopico</a> API.
            By leveraging unopico's API, the file transformation logic can be persisted, so developers can write the
            logic in javascript, and share. This way, other people can upload their own files to run against the persisted
            transformation logic.
        </p>

        <br />

        <p>
            OPTIMUS leverages Web Workers and other techniques to enable parsing of large files (up to several hundred megabytes).
            This tool is free to use and pull requests are welcomed here:
            <a href="https://github.com/hyusetiawan/optimus">OPTIMUS</a>
            None of the data touches the server, all of the processing is done on your own browser.
            For developers, to get started, click the <a href="#/edit">Edit Mode</a>
        </p>

    </div>

    <div class="views help padded">

        <h4 class="title">Users</h4>
        <p>
            Drag and drop the file or files, you would like to process.
        </p>

        <br />

        <h4 class="title">Developers</h4>
        <p>
            Go to <b>Mode > Edit</b> to create the transformation logic. There are tooltips sprinkled all over the Edit mode to guide
            you through the process and what it is capable of.
        </p>

    </div>
    <script id="worker" type="text/javascript">
        {{transformer}}
        var send = function send(){
            if(arguments.length == 1){
                postMessage({cmd: 'done', data: arguments[0]})
            } else {
                //http://developerblog.redhat.com/2014/05/20/communicating-large-objects-with-web-workers-in-javascript/
                postMessage({cmd: 'step', data: arguments[0], step: arguments[1], total: arguments[2]})
            }
        }

        self.onmessage = function(e){
            var data = e.data

            switch(data.cmd){
                case 'run':
                    var file = data.file
                    var options = data.options
                    var $data = null;

                    if (options.auto) {
                        postMessage({cmd: 'info', msg: 'Reading Data'})
                        var reader = new FileReader()
                        reader.onload = function(){
                            var auto = options.auto
                            if(auto == 'auto'){
                                if(file.type.indexOf('json') >= 0) auto = 'json'
                                else if (file.type.indexOf('csv') >= 0) auto = 'csv'
                                else auto = 'txt'
                            }

                            switch(auto){
                                case 'json':
                                    $data = JSON.parse(reader.result)
                                    break
                                case 'csv':
                                    importScripts(['https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js'])
                                    $data = Papa.parse(reader.result).data
                                    break
                                default:
                                    $data = reader.result
                                    break
                            }
                            transformer(file, send, $data)
                        }
                        if(reader[options.auto])reader[options.auto](file)
                        else reader.readAsText(file)
                    } else {
                        transformer(file, send, $data)
                    }

                    break;

            }
        }
    </script>

    <script type="text/javascript" src="https://unopi.co/static/unopico.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/3.3.0/js/jquery.tooltipster.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/path.js/0.8.4/path.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/progressbar.js/0.9.0/progressbar.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2014-11-29/FileSaver.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-tagsinput/1.3.6/jquery.tagsinput.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pubsub-js/1.5.3/pubsub.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/markdown.js/0.5.0/markdown.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/0.7.3/purify.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/codemirror.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/addon/edit/closebrackets.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/addon/edit/matchbrackets.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/addon/edit/matchtags.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/addon/edit/closetag.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/mode/javascript/javascript.min.js"></script>

    <script type="text/javascript" src="setup_upload.js"></script>
    <script type="text/javascript" src="setup_file_saver.js"></script>
    <script type="text/javascript" src="main.js"></script>
</body>
</html>