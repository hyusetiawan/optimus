<html>
<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/codemirror.min.css" rel="stylesheet" type='text/css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/codemirror.min.css" rel="stylesheet" type='text/css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/theme/monokai.min.css" rel="stylesheet" type='text/css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/3.3.0/css/tooltipster.min.css" rel="stylesheet" type='text/css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/3.3.0/css/themes/tooltipster-light.min.css" rel="stylesheet" type='text/css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-tagsinput/1.3.6/jquery.tagsinput.min.css" type="text/css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="main.css">
</head>

<body>
    <!-- taken from: http://codepen.io/philhoyt/pen/ujHzd-->
    <nav class="page-level primary_nav_wrap">
        <ul>
            <li class="logo"><a href="#/">OPTIMUS</a></li>
            <li><a href="#">Mode</a>
                <ul>
                    <li><a href="#/edit">Edit</a></li>
                    <li><a href="#/ready">Ready</a></li>
                </ul>
            </li>
            <li><a href="#/about">About</a></li>
            <li><a href="#/help">Help</a></li>
        </ul>
    </nav>
    <div class="cleared"></div>
    <hr />
    <div class="views welcome">Welcome</div>
    <div class="views ready">
        <form class="upload-file">
            <div class="menu">
                <input class="clear-files" type="button" value="CLEAR FILES" />
                <input class="process-all" type="button" value="PROCESS ALL" />
            </div>
            <table id="file-list" border="0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Size</th>
                        <th>Process</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <input id="file-input" type="file" />
            <label id="file-info"  for="file-input">Click to Upload Files or Drag and Drop Files</label>
        </form>

    </div>
    <div class="views edit">
        <nav class="sub-level primary_nav_wrap">
            <ul >
                <li><a href="#/edit/transformer">Transformer</a></li>
                <li><a href="#/edit/output">Output</a></li>
            </ul>
            <form class="dev-form">
                <input title="saves the app <br />hotkey: <hotkey>" class="save-button" type="button" value="SAVE" />
                <input title="runs the app against the uploaded file (Mode > Ready) <br />hotkey: <hotkey>" class="run-button" type="button" value="RUN">
            </form>
        </nav>

        <div class="cleared"></div>
        <br />
        <div class="subviews transformer">
            <div class="padded">
                <div class="auto-parse">
                    <b>Auto Parse:</b>
                    <select id="auto" title="Automatically parses the file, which content, then passed to transformer(file) as $data">
                        <option value="auto">AUTO</option>
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="nl">New Line</option>
                        <option value="readAsText">AsText</option>
                        <option value="readAsDataURL">AsDataURL</option>
                        <option value="readAsBinaryString">asBinaryString</option>
                        <option value="readAsArrayBuffer">asArrayBuffer</option>
                    </select>
                </div>

                <label class="editor-theme" title="change the editor's theme">
                    Editor's Theme
                    <select id="theme">
                    <option selected>default</option>
                    <option>3024-day</option>
                    <option>3024-night</option>
                    <option>abcdef</option>
                    <option>ambiance</option>
                    <option>base16-dark</option>
                    <option>base16-light</option>
                    <option>bespin</option>
                    <option>blackboard</option>
                    <option>cobalt</option>
                    <option>colorforth</option>
                    <option>dracula</option>
                    <option>eclipse</option>
                    <option>elegant</option>
                    <option>erlang-dark</option>
                    <option>hopscotch</option>
                    <option>icecoder</option>
                    <option>isotope</option>
                    <option>lesser-dark</option>
                    <option>liquibyte</option>
                    <option>material</option>
                    <option>mbo</option>
                    <option>mdn-like</option>
                    <option>midnight</option>
                    <option>monokai</option>
                    <option>neat</option>
                    <option>neo</option>
                    <option>night</option>
                    <option>paraiso-dark</option>
                    <option>paraiso-light</option>
                    <option>pastel-on-dark</option>
                    <option>railscasts</option>
                    <option>rubyblue</option>
                    <option>seti</option>
                    <option>solarized</option>
                    <option>the-matrix</option>
                    <option>tomorrow-night-bright</option>
                    <option>tomorrow-night-eighties</option>
                    <option>ttcn</option>
                    <option>twilight</option>
                    <option>vibrant-ink</option>
                    <option>xq-dark</option>
                    <option>xq-light</option>
                    <option>yeti</option>
                    <option>zenburn</option>
                </select> <br />
                </label>
            </div>

            <textarea id="transformer">function transformer(file, $data){
  /**
    @file   instance of File
    @$data  parsed data, null if you didn't choose the auto parse
  */

  var scripts = [
    'https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js'
  ]
  importScripts.apply(null, scripts) // if you would like to use other libraries

  for (var i = 0; i < $data.length; i++){
    //do some transformation
    $data[i].name = $data[i].name.toUpperCase()
  }

  return $data // return the result
}</textarea>
        </div>
        <div class="subviews output">
            <form class="padded">
                <table>
                    <tr>
                        <td class="input-label">Content Type</td>
                        <td>
                            <select id="content-type" name="content-type">
                                <option value=""> - </option>
                                <option value="original">ORIGINAL</option>
                                <option value="json">JSON</option>
                                <option value="csv">CSV</option>
                                <option value="nl">New Line</option>
                                <option value="txt">TXT</option>
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <td class="input-label"><label for="autosave">Auto Save</label></td>
                        <td><input id="autosave" type="checkbox" /></td>
                    </tr>

                    <tr>
                        <td class="input-label">Filename Pattern</td>
                        <td style="">
                            <input id="filename-pattern" type="text" name="tags" placeholder="" class="tags-input" value="$original"/>
                            <input id="select-tag" type="text" name="tags" placeholder="Tags" class="tags-input"
                                   value="$timestamp, $original, $counter, $uuid" />
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>

    <div class="views about padded">
        <h3 class="title">About</h3>
        <p>
            OPTIMUS is an open source transformation tool using <a href="https://unopi.co">unopico</a> API. The tool
            leverages Web Workers and other techniques to enable parsing of large files (up to several hundred megabytes).
            This tool is free to use and pull requests are welcomed here:
            <a href="https://github.com/hyusetiawan/optimus">OPTIMUS</a>
        </p>
        <br />
        <p>
            None of the data touches the server, all of the processing is done on your own browser.
            To get started as a developer, hit <b>Mode > Ready </b>
        </p>

    </div>

    <div class="views help padded">

        <h4 class="title">Users</h4>
        <p>
            Drag and drop the file or files, you would like to process.
        </p>

        <br />

        <h4 class="title">Developers</h4>
        <p>
            Go to <b>Mode > Edit</b> to create the transformation logic. There are tooltips sprinkled all over the Edit mode to guide
            you through the process and what it is capable of.
        </p>

    </div>
    <script id="worker" type="text/javascript">
        {{transformer}}


        self.onmessage = function(e){
            var data = e.data

            switch(data.cmd){
                case 'run':
                    var file = data.file
                    var options = data.options
                    var $data = null;
                    var runTransformer = function runTransformer(){
                        var result = transformer(file, $data)

                        if(Array.isArray(result)){
                            //http://developerblog.redhat.com/2014/05/20/communicating-large-objects-with-web-workers-in-javascript/
                            //do progress so it wont crash
                            var total = result.length
                            for(var i = 0; i < total; i++){
                                postMessage({
                                    cmd: 'step',
                                    data: result[i],
                                    step: i + 1,
                                    total: total
                                })
                            }
                        } else {
                            postMessage({
                                cmd: 'done',
                                data: result
                            })
                        }
                    }


                    if (options.auto) {
                        var reader = new FileReader()
                        reader.onload = function(){
                            var auto = options.auto
                            if(auto == 'auto'){
                                if(file.type.indexOf('json') >= 0) auto = 'json'
                                else if (file.type.indexOf('csv') >= 0) auto = 'csv'
                                else auto = 'txt'
                            }

                            switch(auto){
                                case 'json':
                                    $data = JSON.parse(reader.result)
                                    break
                                case 'csv':
                                    importScripts(['https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js'])
                                    $data = Papa.parse(reader.result)
                                    break
                                default:
                                    $data = reader.result
                                    break
                            }
                            runTransformer()
                        }
                        if(reader[options.auto])reader[options.auto](file)
                        else reader.readAsText(file)

                    }

                    break;

            }
        }
    </script>

    <script type="text/javascript" src="https://unopi.co/static/unopico.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/3.3.0/js/jquery.tooltipster.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/path.js/0.8.4/path.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2014-11-29/FileSaver.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-tagsinput/1.3.6/jquery.tagsinput.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/codemirror.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/addon/edit/closebrackets.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/addon/edit/matchbrackets.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/addon/edit/matchtags.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/addon/edit/closetag.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/mode/javascript/javascript.min.js"></script>
    <script type="text/javascript" src="setup_upload.js"></script>
    <script type="text/javascript" src="setup_file_saver.js"></script>
    <script type="text/javascript" src="main.js"></script>
</body>
</html>